<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Idle Breakout Save Editor</title>

    <style>
        .group .tooltip {
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(55, 65, 81, 0.9);
            /* gray-700 */
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .group:hover .tooltip {
            opacity: 1;
            transition-delay: 0.25s;
        }

        .group .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: rgba(55, 65, 81, 0.9) transparent transparent transparent;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col items-center p-6">

    <h1 class="text-2xl font-bold mb-4">Idle Breakout Save Editor</h1>

    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between w-full mb-4 bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-sm">
        <p class="text-gray-700 text-sm sm:text-base mb-2 sm:mb-0">
            The save editor by <a href=https://github.com/dimani128>dimani128</a> with the most complete and accurate Idle Breakout save format information.
        </p>
        <div id="fieldsBadge" class="bg-blue-600 text-white font-semibold px-3 py-1 rounded-full text-sm shadow-md">
            Loading...
        </div>
    </div>

    <div class="w-full bg-white shadow-md rounded-lg p-6 space-y-4">
        <div>
            <label class="block text-sm font-semibold mb-2">Save String</label>
            <textarea id="saveInput" rows="3" placeholder="Paste your save here..."
                class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></textarea>
        </div>

        <button id="copyButton" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
            Copy to Clipboard
        </button>

        <div class="flex items-center space-x-3">
            <input type="number" id="customIndexInput" placeholder="Index (0-125)" min="0" max="125"
                class="w-32 p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500" />
            <input type="number" id="customValueInput" placeholder="Value"
                class="flex-1 p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500" />
            <button id="setCustomValueButton"
                class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition">
                Set Value
            </button>
        </div>

        <div id="fieldsContainer" class="space-y-3 mt-6"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const totalFields = 126;
            const implemented = (typeof fields !== "undefined" ? fields.length : 0);
            const percent = ((implemented / totalFields) * 100).toFixed(1);
            const badge = document.getElementById("fieldsBadge");
            if (badge) {
                badge.textContent = `${implemented} / ${totalFields} fields implemented (${percent}%)`;
            }
        });
        document.addEventListener("DOMContentLoaded", () => {
            clearTimeout(saveTimeout); // TODO: move to method and merge with the save box input handler
            saveTimeout = setTimeout(() => {
                if (saveInput.value.trim()) {
                    parseSaveString(saveInput.value);
                }
            }, 10);
        });

        const fields = [
            {index: 0, label: "Level", type: "number"},
            {index: 1, label: "Money", type: "number"},
            {index: 2, label: "Gold", type: "number"},
            {index: 3, label: "Next Gold Block Value", type: "number"},
            {index: 4, label: "Prestige Count", type: "number"},
            {index: 5, label: "Blocks Broken (Power-ups)", type: "number"},
            {index: 6, label: "Blocks Broken (Advancements)", type: "number"},
            {index: 7, label: "Black Bricks Broken (Achievements)", type: "number"},
            {index: 8, label: "Power-ups Available", type: "number"},
            {index: 11, label: "Ball Facts", type: "bool"},
            {index: 12, label: "Bonus Alerts", type: "bool"},
            {index: 13, label: "Effects", type: "bool"},
            {index: 28, label: "Basic Balls", type: "number"},
            {index: 29, label: "Plasma Balls", type: "number"},
            {index: 30, label: "Sniper Balls", type: "number"},
            {index: 31, label: "Scatter Balls", type: "number"},
            {index: 32, label: "Cannon Balls", type: "number"},
            {index: 33, label: "Poison Balls", type: "number"},
            {index: 37, label: "Basic Ball Speed Upgrades", type: "number"},
            {index: 38, label: "Basic Ball Power Upgrades", type: "number"},
            {index: 39, label: "Plasma Ball Range Upgrades", type: "number"},
            {index: 40, label: "Plasma Ball Power Upgrades", type: "number"},
            {index: 41, label: "Sniper Ball Speed Upgrades", type: "number"},
            {index: 42, label: "Sniper Ball Power Upgrades", type: "number"},
            {index: 43, label: "Scatter Ball Extra Ball Upgrades", type: "number"},
            {index: 44, label: "Scatter Ball Power Upgrades", type: "number"},
            {index: 45, label: "Cannonball Speed Upgrades", type: "number"},
            {index: 46, label: "Cannonball Power Upgrades", type: "number"},
            {index: 47, label: "Poison Ball Speed Upgrades", type: "number"},
            {index: 48, label: "Poison Ball Power Upgrades", type: "number"},
            {index: 51, label: "Click Power Upgrades", type: "number"},
            {index: 52, label: "Level Complete Cash Bonus Upgrades", type: "number"},
            {index: 53, label: "Ball Speed Increase Upgrades", type: "number"},
            {index: 54, label: "Ball Power Multiplier Upgrades", type: "number"},
            {index: 55, label: "VAUS Laser Upgrades", type: "number", info: "Values above 4 are treated as 4"},
            {index: 56, label: "Max Ball Count Upgrades", type: "number"},
            {index: 56, label: "Lasers", type: "number"},
            {index: 69, label: "Cashed Up powerup used", type: "bool"},
            {index: 70, label: "Click Frenzy powerup used", type: "bool"},
            {index: 71, label: "Demon Core powerup used", type: "bool"},
            {index: 72, label: "Snow Ball powerup used", type: "bool"},
            {index: 73, label: "2x Gold powerup used", type: "bool"},
            {index: 74, label: "Skill - Basic Balls - 1 - Basic Balls Always Damage Black Bricks", type: "bool"},
            {index: 75, label: "Skill - Basic Balls - 2 - Retain Earned Black Bricks After Prestige", type: "bool"},
            {index: 76, label: "Skill - Basic Balls - 3 - Basic Balls Have a Small Change of Damaging All Bricks At Once", type: "bool"},
            {index: 77, label: "Skill - Basic Balls - 4 - Basic Ball Power Multiplies for Every Basic Ball You Have", type: "bool"},
            {index: 79, label: "Skill - Plasma Balls - 1 - Plasma Balls Always Damage Black Bricks", type: "bool"},
            {index: 80, label: "Skill - Plasma Balls - 2 - Splash Damage From Plasma Balls 4x", type: "bool"},
            {index: 81, label: "Skill - Plasma Balls - 3 - Plasma Balls Have a Small Chance of Damaging All Bricks at Once", type: "bool"},
            {index: 82, label: "Skill - Plasma Balls - 4 - Boss Bricks Lose All Laser Protection", type: "bool"},
            {index: 84, label: "Skill - Sniper Balls - 1 - Sniper Balls Always Damage Black Bricks", type: "bool", warning: "This value is always overridden to 1 in-game."},
            {index: 85, label: "Skill - Sniper Balls - 2 - Offline Cash Earnings 10x", type: "bool"},
            {index: 86, label: "Skill - Sniper Balls - 3 - Sniper Balls Have a Small Chance of Damaging All Bricks at Once", type: "bool"},
            {index: 87, label: "Skill - Sniper Balls - 4 - Increase Speed Limit to 60", type: "bool", info: "(from a previous cap of 10)"},
            {index: 89, label: "Skill - Scatter Balls - 1 - Scatter Balls Always Damage Black Bricks", type: "bool"},
            {index: 90, label: "Skill - Scatter Balls - 2 - Single Hit Scatter Balls Damage 2x", type: "bool", info: "now up to the full damage of the base scatter ball"},
            {index: 91, label: "Skill - Scatter Balls - 3 - Scatter Balls Have a Small Chance of Damaging All Bricks at Once", type: "bool"},
            {index: 92, label: "Skill - Scatter Balls - 4 - Powerup Duration Doubled", type: "bool"},
            {index: 94, label: "Skill - Cannonballs - 1 - Cannonballs Always Damage Black Bricks", type: "bool"},
            {index: 95, label: "Skill - Cannonballs - 2 - Lasers Always Damage Black Bricks", type: "bool"},
            {index: 96, label: "Skill - Cannonballs - 3 - Cannonballs Have a Small Chance of Damaging All Bricks at Once", type: "bool"},
            {index: 97, label: "Skill - Cannonballs - 4 - Enable Mouse Hold to Click", type: "bool"},
            {index: 99, label: "Skill - Poison Balls - 1 - Poison Balls Always Damage Black Bricks", type: "bool"},
            {index: 100, label: "Skill - Poison Balls - 2 - Poisoned Bricks Take Damage Over Time", type: "bool"},
            {index: 101, label: "Skill - Poison Balls - 3 - Poison Balls Have a Small Chance of Damaging All Bricks at Once", type: "bool"},
            {index: 102, label: "Skill - Poison Balls - 4 - Poisoned Bricks Slowly Infect Nearby Bricks", type: "bool"},
            {index: 104, label: "Black Bricks", type: "number"},
            {index: 105, label: "Cursor Color", type: "dropdown", values: ["OS Default", "Red", "Green", "Blue", "Black"]}, // TODO: figure out why the dropdown content background is grey
            {index: 106, label: "Background Color", type: "dropdown", values: ["Beige", "Pink", "Green", "Blue", "Purple"]},
            {index: 109, label: "Skill Points", type: "number"},
            {index: 110, label: "Volume Enabled", type: "bool"},
        ];

        let values = new Array(126).fill("0");

        const saveInput = document.getElementById("saveInput");
        const fieldsContainer = document.getElementById("fieldsContainer");
        fieldsContainer.className = "grid grid-cols-[auto_auto_1fr] gap-3 mt-6";
        const copyButton = document.getElementById("copyButton");

        fields.forEach(f => { // TODO: add in for=... for each one
            const div = document.createElement("div");
            div.className = "contents";

            let inputHTML = "";
            if (f.type === "bool") {
                inputHTML = `
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="field-${f.index}" data-index="${f.index}" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-300 rounded-full peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 peer-checked:bg-blue-600 transition-all"></div>
                <div class="absolute left-0.5 top-0.6 w-5 h-5 bg-white rounded-full shadow-md peer-checked:translate-x-5 transition-transform"></div>
            </label>
            `;
            } else if (f.type === "dropdown") {
                const optionsHTML = f.values.map(v => `<option value="${v}">${v}</option>`).join("");
                inputHTML = `
            <select id="field-${f.index}" data-index="${f.index}"
                class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500">
                ${optionsHTML}
            </select>
            `;
            } else {
                inputHTML = `
            <input type="number" id="field-${f.index}" data-index="${f.index}"
                class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500"
                value="0" min="0" />
            `;
            }

            let labelClass = "font-medium text-gray-700 flex items-center justify-between rounded px-2 py-1 transition relative";
            let tooltipText = "";

            if (f.warning) {
                labelClass += " border border-yellow-400 bg-yellow-100 hover:bg-yellow-200";
                tooltipText = f.warning;
            } else if (f.info) {
                labelClass += " border border-blue-400 bg-blue-100 hover:bg-blue-200";
                tooltipText = f.info;
            }

            div.innerHTML = `
            <div class="text-right pr-2 font-mono text-gray-500">${f.index}</div>
            <div class="group ${labelClass}">
            <span>${f.label}</span>
            ${tooltipText ? `<div class="tooltip">${tooltipText}</div>` : ""}
            </div>
            ${inputHTML}
        `;
            fieldsContainer.appendChild(div);
        });

        function parseSaveString(saveStr) {
            try {
                const decoded = atob(saveStr.trim());
                const parts = decoded.split(",").map(p => p.trim());
                values = parts.map(v => String(v));

                fields.forEach(f => {
                    const input = document.getElementById(`field-${f.index}`);
                    if (!input) return;

                    if (f.type === "bool") {
                        input.checked = values[f.index] === "1";
                    } else if (f.type === "dropdown") {
                        const val = f.values[parseInt(values[f.index])] || f.values[0];
                        input.value = val;
                    } else {
                        input.value = values[f.index] ?? "0";
                    }
                });

                return true;
            } catch (e) {
                console.error("Decoding error:", e);
                return false;
            }
        }

        function rebuildEncodedSave() {
            const fullValues = new Array(126).fill("0");
            values.forEach((v, idx) => {
                if (idx < 126) fullValues[idx] = v;
            });
            return btoa(fullValues.join(","));
        }

        let saveTimeout;
        saveInput.addEventListener("input", () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                if (saveInput.value.trim()) {
                    parseSaveString(saveInput.value);
                }
            }, 10);
        });

        fieldsContainer.addEventListener("input", (e) => {
            const input = e.target;
            if (!input.dataset.index) return;

            const i = parseInt(input.dataset.index);
            const f = fields.find(f => f.index === i);

            if (input.type === "checkbox") {
                values[i] = input.checked ? "1" : "0";
            } else if (f && f.type === "dropdown") {
                values[i] = String(f.values.indexOf(input.value));
            } else {
                values[i] = input.value || "0";
            }

            saveInput.value = rebuildEncodedSave();
        });

        copyButton.addEventListener("click", async () => {
            if (!saveInput.value.trim()) return;
            try {
                await navigator.clipboard.writeText(saveInput.value);
                copyButton.textContent = "Copied!";
                copyButton.className = "bg-green-500 text-white px-6 py-2 rounded-lg transition";
                setTimeout(() => {
                    copyButton.textContent = "Copy to Clipboard";
                    copyButton.className = "bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition";
                }, 1500);
            } catch (err) {
                console.error("Failed to copy:", err);
            }
        });

        const customIndexInput = document.getElementById("customIndexInput");
        const customValueInput = document.getElementById("customValueInput");
        const setCustomValueButton = document.getElementById("setCustomValueButton");

        [customIndexInput, customValueInput].forEach(input => {
            input.addEventListener("keydown", e => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    handleSetValue();
                }
            });
        });

        function handleSetValue() {
            const index = parseInt(customIndexInput.value);
            const newValue = customValueInput.value.trim();

            if (isNaN(index) || index < 0 || index >= 126) return;
            if (!newValue) return;

            values[index] = newValue;

            const existingField = document.getElementById(`field-${index}`);
            if (existingField) {
                const f = fields.find(f => f.index === index);
                if (existingField.type === "checkbox") {
                    existingField.checked = newValue === "1";
                } else if (f && f.type === "dropdown") {
                    existingField.value = f.values[parseInt(newValue)] || f.values[0];
                } else {
                    existingField.value = newValue;
                }
            }

            saveInput.value = rebuildEncodedSave();
        }

        setCustomValueButton.addEventListener("click", handleSetValue);
    </script>
</body>

</html>
